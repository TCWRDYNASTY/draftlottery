<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="data:,">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantasy Football Draft Lottery</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <style>
   :root {
    --primary-dark: #1e3159; 
    --accent-gold: #FFD700; 
    --light-text: #f0f4f8; 
    --container-bg: #2a3d60; 
    --section-bg: #3c5283; 
    --highlight-blue: #6495ed; 
}

body {
    font-family: 'Inter', sans-serif;
    background-color: var(--primary-dark);
    color: var(--light-text);
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    margin: 0;
    padding: 2rem 1rem;
    box-sizing: border-box;
    background-image:
        radial-gradient(circle at 10% 90%, rgba(255, 215, 0, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 90% 10%, rgba(255, 215, 0, 0.05) 0%, transparent 50%); 
}

.container {
    width: 100%;
    max-width: 950px;
    margin: 0 auto;
    background-color: #2a3d60;
    border-radius: 2rem;
    padding: 2.5rem;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), inset 0 0 30px rgba(0, 0, 0, 0.2);
    border: 4px solid var(--accent-gold);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: auto;
    position: relative;
    z-index: 1; 
}

h1, h2 {
    font-family: 'Bebas Neue', sans-serif;
    letter-spacing: 0.1em;
    text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
    -webkit-text-stroke: 1px var(--primary-dark);
}

h1 {
    font-size: 3.5rem;
    margin-bottom: 0.5rem;
    background: linear-gradient(90deg, #FFD700, #FFEF9F);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

h2 {
    font-size: 2.5rem;
    margin-top: 2rem;
    margin-bottom: 1.5rem;
    color: var(--light-text);
}

/* --- THE MAIN CURTAIN CONTAINER --- */
#curtainWrapper {
    position: fixed;
    inset: 0;
    display: flex; /* Change from 'none' to 'flex' */
    z-index: 9999; /* Just below the rules (10000) but above the machine */
    pointer-events: none; /* Allows you to click the rules overlay through it */
}

/* THE PANELS */
.curtain-panel {
    position: absolute;
    top: 0;
    width: 50.5%; /* Added .5% overlap to prevent a tiny gap in the middle */
    height: 100%;
    background-image: url('badbunny4.png'); 
    background-size: 200% 100%;
    background-repeat: no-repeat;
    background-color: #000;
    transition: transform 3s cubic-bezier(0.7, 0, 0.3, 1);
    z-index: 100;
    will-change: transform;
}

/* LEFT SIDE */
.left-panel {
    left: 0;
    background-position: 0% center; 
    border-right: 2px solid rgba(0, 0, 0, 0.5);
    transform: translateX(0); /* Default closed */
}

/* RIGHT SIDE */
.right-panel {
    right: 0;
    background-position: 100% center; 
    border-left: 2px solid rgba(0, 0, 0, 0.5);
    transform: translateX(0); /* Default closed */
}

/* TEXTURE/FOLDS EFFECT */
.curtain-panel::after {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: repeating-linear-gradient(90deg, transparent, rgba(0,0,0,0.2) 20px, transparent 40px);
}

/* ANIMATION STATES */
/* Open state: slide them out */
#curtainWrapper.open .left-panel { transform: translateX(-100%); }
#curtainWrapper.open .right-panel { transform: translateX(100%); }

/* --- THE WINNER OVERLAY (ON TOP OF EVERYTHING) --- */
#winnerOverlay {
    position: fixed;
    inset: 0;
    z-index: 100000 !important; /* One level higher than curtains */
    background-color: rgba(0, 0, 0, 0.95);
    display: none; /* JS toggles to flex */
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
    text-align: center;
    overflow: hidden;
}

#winnerImage {
    max-width: 85vw;    /* Limits width to 85% of screen */
    max-height: 50vh;   /* Limits height to 50% of screen */
    object-fit: contain; /* Keeps hotdog from stretching */
    border-radius: 1rem;
    border: 4px solid #FFD700; /* Your gold border */
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    margin: 20px 0;
}

/* Responsive Text Scaling */
#winnerOverlay h1 {
    font-size: clamp(2rem, 8vw, 5rem); 
    color: white;
    font-weight: bold;
    margin-bottom: 10px;
    line-height: 1;
}

#finalWinnerName {
    font-size: clamp(1.5rem, 6vw, 4rem);
    color: #FFD700;
    font-weight: 900;
    text-transform: uppercase;
}

.curtain-wrapper {
    z-index: 9998;
}

.audio-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: radial-gradient(circle, #1a1a1a 0%, #000000 100%);
    z-index: 9999; 
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    cursor: pointer;
    color: white;
}
        
.lottery-machine {
    position: relative;
    width: 80vw;
    max-width: 400px;
    aspect-ratio: 1;
    border-radius: 50%;
    margin: 3rem auto;
    overflow: hidden !important;
    border: 15px solid #a0b3c8;
    background: radial-gradient(circle at center, #5b6d90, #2c3e59);
    box-shadow: 0 0 50px rgba(255, 215, 0, 0.2), inset 0 0 80px rgba(255, 255, 255, 0.1), inset 0 0 120px rgba(0, 0, 0, 0.7);
    z-index: 10;
}
        
.ball {
    position: absolute;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 20;
    border: 2px solid var(--accent-gold);
    background-size: cover;
    background-position: center;
    box-shadow: 0 5px 10px rgba(0, 0, 0, 0.5), inset 0 0 10px rgba(255,255,255,0.8);
    animation: circle-motion 8s linear infinite;
    transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
}

.ball.converging {
    animation: none !important;
    left: 50% !important;
    top: 50% !important;
    transform: translate(-50%, -50%) !important;
    z-index: 100 !important;
}

.ball.merged {
    transform: translate(-50%, -50%) scale(2.6) !important;
    z-index: 200 !important;
    box-shadow: 0 0 30px gold, 0 0 60px gold, 0 0 100px rgba(255, 215, 0, 0.8) !important;
}
.ball.vanish {
    animation: vanishPop 0.7s ease forwards !important;
}

@keyframes vanishPop {
    0%   { transform: translate(-50%, -50%) scale(2.6); opacity: 1; }
    60%  { transform: translate(-50%, -50%) scale(3.2); opacity: 1; }
    100% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
}

/* 1. The Containers (Walls) */
.team-odds-section, .results-section {
    margin-top: 2rem;
    background-color: var(--section-bg);
    border-radius: 1rem;
    padding: 2rem;
    box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.4);
    border: 2px solid var(--highlight-blue);
    width: 100%;
}

/* 2. The List Layout (Furniture) - DO NOT SKIP THIS */
#teamOddsList, .results-list {
    list-style: none;
    padding: 0;
    margin-top: 1rem;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1rem;
}

#teamOddsList li {
    background-color: var(--container-bg);
    padding: 1rem;
    border-radius: 0.75rem;
    font-weight: bold;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-left: 5px solid var(--accent-gold);
    transition: all 0.8s ease;
}

/* 3. The "Picked" state (Red Strike-through) */
#teamOddsList li.picked-team {
    background-color: #1a1a1a !important; 
    opacity: 0.4 !important; 
    filter: grayscale(100%);
    border-left-color: #444 !important;
    transform: scale(0.96);
    pointer-events: none;
}

/* Ensure BOTH name and percent get the red strike */
#teamOddsList li.picked-team .team-name,
#teamOddsList li.picked-team .odds-percent {
    color: #999 !important;
    text-decoration: line-through !important;
    text-decoration-color: #ff4444 !important; 
    text-decoration-thickness: 4px !important;
}

/* 4. The Big Display for the winner ball */
.drawn-ball-display {
    min-height: 120px;
    background-color: var(--section-bg);
    border-radius: 1.5rem;
    padding: 1.5rem;
    margin-top: 2rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    border: 4px dashed var(--accent-gold);
    position: relative;
}

.drawn-ball-display .drawn-team-name {
    font-size: 3.5rem;
    font-weight: 900;
    font-family: 'Bebas Neue', sans-serif;
    color: #FFD700;
    text-shadow: 2px 2px 0px #000, 0 0 15px rgba(255, 215, 0, 0.6);
}

.btn {
    background: linear-gradient(90deg, #FFD700, #FFEF9F);
    color: var(--primary-dark);
    padding: 1rem 2rem;
    border-radius: 1rem;
    font-weight: 900;
    font-size: 1.5rem;
    cursor: pointer;
    text-transform: uppercase;
    font-family: 'Bebas Neue', sans-serif;
    transition: all 0.3s ease;
}

.btn:hover:not(:disabled) {
    transform: translateY(-5px) scale(1.05);
}

.hidden { display: none !important; }

/* --- CORE ANIMATIONS --- */
@keyframes circle-motion {
    0% { transform: rotate(0deg) translateX(var(--circle-radius, 50px)) rotate(0deg); }
    100% { transform: rotate(360deg) translateX(var(--circle-radius, 50px)) rotate(-360deg); }
}

@keyframes pulse {
    0% { transform: scale(1); opacity: 0.8; }
    50% { transform: scale(1.05); opacity: 1; }
    100% { transform: scale(1); opacity: 0.8; }
}
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<audio id="monacoAudio" src="Monaco.m4a" preload="auto"></audio>

<div id="introOverlay" class="audio-overlay">
    <div class="overlay-content">
        <h1 class="text-accent-gold text-5xl mb-4">TCWR DY-NASTY</h1>
        <h2 class="text-white mb-6">SUPER BOWL HALFTIME LOTTERY</h2>
        
        <div class="bg-gray-900 p-8 rounded-lg border-2 border-gold text-left max-w-2xl mx-auto mb-8 shadow-2xl">
            <h3 class="text-accent-gold font-bold text-2xl mb-4 text-center">HOW THE LOTTERY WORKS</h3>
            <p class="text-white text-lg leading-relaxed mb-6">
                Suspense builds as we reveal the draft order in reverse, from <span class="text-gold font-bold">Pick #8</span> down to <span class="text-gold font-bold">Pick #1</span>.
            </p>
            <ul class="text-white space-y-3 list-disc pl-5 text-md">
                <li><strong class="text-gold">Reverse Reveal:</strong> Once a team is drawn, they are awarded the current pick and eliminated.</li>
                <li><strong class="text-gold">High Odds:</strong> Teams with high weights are more likely to be drawn early for Pick #8.</li>
                <li><strong class="text-gold">The Jackpot:</strong> If a low-odds team survives the early rounds, their shot at Pick #1 becomes massive!</li>
            </ul>
        </div>
        
        <p class="animate-pulse text-3xl font-bold text-gold">CLICK TO COMMENCE THE DRAFT</p>
    </div>
</div>

<div id="curtainWrapper" class="curtain-wrapper">
    <div class="curtain-panel left-panel"></div>
    <div class="curtain-panel right-panel"></div>
</div>

<div class="container">
 <h1 class="text-5xl md:text-6xl mb-8 tracking-widest uppercase text-center mx-auto" style="font-family: 'Bebas Neue', sans-serif; color: #FFD700; letter-spacing: 0.1em; width: 100%;">
    TCWR DY-NASTY Draft Lottery
</h1>

    <div class="lottery-machine" id="lotteryMachine">
        <div class="text-xl font-semibold text-gray-400">Loading draft state...</div>
    </div>

    <div class="drawn-ball-display" id="drawnBallDisplay">
        <div class="current-pick-label" id="currentPickLabel">Ready to Draw for Pick #...</div>
        <div class="drawn-team-name" id="drawnTeamName"></div>
    </div>

    <button class="btn" id="runFullDraftBtn">Run Draft</button>
    
    <div class="results-section">
        <h3 class="text-gold font-bold mb-4 uppercase tracking-wider text-center">Draft Order Reveal</h3>
        <ul id="resultsList" class="results-list">
            </ul>
    </div>

    <div class="team-odds-section">
        <h3 class="text-gold font-bold mb-4 uppercase tracking-wider text-center">Remaining Team Odds</h3>
        <ul id="teamOddsList" class="team-odds-list">
            </ul>
    </div>

    <div class="commissioner-tools mt-12 p-4 border-t border-gray-800">
        <button id="commissionerLogin" class="text-xs opacity-50 hover:opacity-100 text-white">Commissioner Login</button>
        
        <div id="commissionerPanel" class="hidden mt-4 p-6 bg-gray-900 rounded-lg border border-red-900">
            <h3 class="text-red-500 font-bold mb-4">Commissioner Controls</h3>
            <div id="memberConfigInputs" class="space-y-4 mb-6">
                </div>
            <div class="flex gap-4">
                <button id="saveConfigBtn" class="px-4 py-2 bg-green-600 text-white rounded">Save Configuration</button>
                <button id="resetDraftBtn" class="px-4 py-2 bg-red-600 text-white rounded">Reset Draft</button>
            </div>
        </div>
    </div>
</div>

<div id="winnerOverlay" class="hidden fixed inset-0 z-[10000] flex flex-col items-center justify-center bg-black bg-opacity-95">
    <h1 class="text-white text-7xl font-bold mb-8 animate-bounce tracking-tighter">THE #1 PICK</h1>
    <img id="winnerImage" src="hotdog1.png" class="rounded-xl border-4 border-yellow-400 shadow-2xl mx-auto block">
    <div id="finalWinnerName" class="text-gold text-5xl mt-4 font-black"></div>
    </div>
<script type="module">

const pickImages = {
    8: 'hotdog8.png', 7: 'hotdog7.png', 6: 'hotdog6.png', 5: 'hotdog5.png',
    4: 'hotdog4.png', 3: 'hotdog3.png', 2: 'hotdog2.png', 1: 'hotdog1.png'
};
    
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

const COMMISSIONER_PASSWORD = 'Asher'; 
const SUPABASE_URL = 'https://jheqfwykhvyngfqawknr.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpoZXFmd3lraHZ5bmdmcWF3a25yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ5NDE3MjEsImV4cCI6MjA2MDUxNzcyMX0.LLWSmRdZW_5XD2Z8NqGB5BTP3hAtk63pOnZiSckf7BM';
const SUPABASE_TABLE_NAME = 'draft_configs';
const SUPABASE_ORDERS_TABLE_NAME = 'draft_orders';
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let members = []; 
let availableMembers = [];
let draftOrder = [];
let drawing = false;
let pickCounter = 8;
let isDraftSaved = false;

// --- ELEMENT DECLARATIONS ---
const lotteryMachine = document.getElementById('lotteryMachine');
const runFullDraftBtn = document.getElementById('runFullDraftBtn');
const currentPickLabel = document.getElementById('currentPickLabel');
const drawnTeamNameDisplay = document.getElementById('drawnTeamName');
const resultsList = document.getElementById('resultsList');
const teamOddsList = document.getElementById('teamOddsList');
const commissionerLogin = document.getElementById('commissionerLogin');
const commissionerPasswordInput = document.getElementById('commissionerPassword');
const unlockCommissionerBtn = document.getElementById('unlockCommissionerBtn');
const commissionerPanel = document.getElementById('commissionerPanel');
const saveConfigBtn = document.getElementById('saveConfigBtn');
const resetDraftBtn = document.getElementById('resetDraftBtn');
const commissionerLoginContainer = document.querySelector('.commissioner-tools');

// --- COMMISSIONER LOGIC ---
function handleCommissionerUnlock(e) {
    if (e) e.preventDefault();
    // Ensure COMMISSIONER_PASSWORD is defined globally
    if (commissionerPasswordInput.value === COMMISSIONER_PASSWORD) {
        commissionerPanel.classList.remove('hidden');
        commissionerLogin.classList.add('hidden');
        showMessage("Commissioner tools unlocked!", "success");
        console.log("Commissioner panel unlocked.");
    } else {
        showMessage("Incorrect password. Please try again.", "error");
    }
    commissionerPasswordInput.value = ''; 
}

// --- CONSOLIDATED DOMCONTENTLOADED ---
document.addEventListener('DOMContentLoaded', async () => {
    console.log("Initializing Draft Room...");
    if (typeof fetchDraftState === 'function') await fetchDraftState();
    if (typeof renderResultsList === 'function') renderResultsList();
    if (typeof updateOddsDisplay === 'function') updateOddsDisplay();
    if (typeof populateBalls === 'function') populateBalls();
    if (typeof initializeDraftState === 'function') initializeDraftState();
    if (runFullDraftBtn) {
        runFullDraftBtn.addEventListener('click', runFullDraftSimulation);
    }
    if (unlockCommissionerBtn) {
        unlockCommissionerBtn.addEventListener('click', handleCommissionerUnlock);
    }
    if (commissionerLogin) {
        commissionerLogin.addEventListener('submit', handleCommissionerUnlock);
    }
    if (saveConfigBtn) {
        saveConfigBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            await saveConfig(); 
        });
    }
    if (resetDraftBtn) {
        resetDraftBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            if (typeof clearDraftOrderFromSupabase === 'function') {
                const success = await clearDraftOrderFromSupabase();
                if (success) {
                    initializeDraftState();
                    showMessage('Draft has been reset. A new random draft can now be run.');
                }
            }
        });
    }

    const introOverlay = document.getElementById('introOverlay');
    const curtains = document.getElementById('curtainWrapper');
    const audio = document.getElementById('monacoAudio');

    if (introOverlay) {
        introOverlay.addEventListener('click', function() {
            if (audio) audio.play().catch(e => console.log("Audio blocked", e));
            
            // 1. Fade the rules
            this.style.transition = 'opacity 0.6s ease';
            this.style.opacity = '0';
            this.style.pointerEvents = 'none';

            // 2. Since curtains are already display:flex in CSS, just slide them!
            setTimeout(() => {
                this.classList.add('hidden'); 
                
                if (curtains) {
                    curtains.classList.add('open'); // Trigger the slide
                    
                    // Cleanup: Hide wrapper after 3.1s so buttons are clickable
                    setTimeout(() => {
                        curtains.style.display = 'none';
                    }, 3100); 
                }
            }, 600); // Start sliding as soon as the rules fade is mostly done
        }, { once: true });
    }
    });
async function saveDraftOrderToSupabase(draftOrder) {
    console.log('Saving draft order to Supabase...', draftOrder);
    
    const formattedData = draftOrder.map(pick => ({
        id: `pick_${pick.pick}`,
        order_data: {
            pick: pick.pick,
            member: pick.member,
            originalWeightDisplay: pick.originalWeightDisplay
        }
    }));

    const { data, error } = await supabase
        .from('draft_orders')
        .upsert(formattedData, { onConflict: 'id' })
        .select();

    if (error) {
        console.error('Error saving draft order to Supabase:', error);
        return false;
    }
    console.log('Draft order saved successfully:', data);
    return true;
}

async function clearDraftOrderFromSupabase() {
    showMessage('Clearing old draft order from the database...');
    const { error } = await supabase
        .from(SUPABASE_ORDERS_TABLE_NAME)
        .delete()
        .not('id', 'is', null);
    
    if (error) {
        console.error('Error clearing draft order:', error);
        showMessage('Error clearing draft order. Check console.');
        return false;
    }
    console.log('Draft order cleared successfully.');
    sessionStorage.removeItem('hasSeenDraftAnimation');
    return true;
}

async function initializeDraftState() {
    members = await fetchMembersFromSupabase();
    if (members.length === 0) {
        lotteryMachine.innerHTML = '<div class="text-xl font-semibold text-gray-400">No teams configured! Use Commissioner Tools to add teams and save the configuration.</div>';
        if (runFullDraftBtn) runFullDraftBtn.disabled = true;
        return;
    }

    const savedDraftOrder = await loadDraftOrderFromSupabase();
    const hasSeenAnimation = sessionStorage.getItem('hasSeenDraftAnimation');

    if (savedDraftOrder && savedDraftOrder.length > 0) {
        isDraftSaved = true;
        draftOrder = savedDraftOrder.sort((a, b) => a.pick - b.pick);
        
       if (hasSeenAnimation) {
       console.log('Saved draft found, user has seen animation. Displaying results.');
    showResults();
    displayTeamOdds();
            if (runFullDraftBtn) {
                runFullDraftBtn.textContent = 'Replay Draft Animation';
                runFullDraftBtn.disabled = false;
            }
            if (currentPickLabel) currentPickLabel.textContent = "Draft Complete! Click to Replay.";
            pickCounter = members.length;
            availableMembers = members.map(member => ({ ...member }));
            populateBalls(); 
        }
        else {
            console.log('Saved draft found, user has NOT seen animation. Setting up for first-time run.');
            if (resultsList) resultsList.style.display = 'none';
            if (runFullDraftBtn) {
                runFullDraftBtn.textContent = 'Run Draft';
                runFullDraftBtn.disabled = false;
            }
            if (currentPickLabel) currentPickLabel.textContent = "Click 'Run Draft' to begin!";
       
            pickCounter = members.length;
            availableMembers = members.map(member => ({ ...member }));
            populateBalls();
            displayTeamOdds();
            initializeResultsList();
        }
    } else {
        console.log('No saved draft found. Setting up for a new random run.');
        isDraftSaved = false;
        availableMembers = members.map(member => ({ ...member }));
        draftOrder = [];
        pickCounter = members.length;
        if (runFullDraftBtn) {
            runFullDraftBtn.textContent = 'Run Draft';
            runFullDraftBtn.disabled = false;
        }
        if (resultsList) resultsList.style.display = 'block';
        initializeResultsList();
        populateBalls();
        displayTeamOdds();
        drawnTeamNameDisplay.textContent = '...';
        currentPickLabel.textContent = `Ready to Draw for Pick #${pickCounter}...`;
    }
    
    initializeMemberConfigInputs();
}

function initializeMemberConfigInputs() {
    if (!memberConfigInputs) return;
    memberConfigInputs.innerHTML = '';
    members.forEach(member => {
        const div = document.createElement('div');
        div.className = 'p-4 bg-gray-800 rounded-lg border border-gray-700 flex flex-wrap gap-4 items-end mb-3';
        div.innerHTML = `
            <div class="flex flex-col flex-1 min-w-[200px]">
                <label class="text-xs text-orange-400 uppercase font-bold mb-1">Team Name</label>
                <input type="text" id="name-${member.id}" value="${member.name}" 
                       class="p-2 rounded bg-gray-900 border border-gray-600 text-white">
            </div>
            <div class="flex flex-col w-24">
                <label class="text-xs text-orange-400 uppercase font-bold mb-1">Math Weight</label>
                <input type="number" id="weight-${member.id}" value="${member.weight}" 
                       class="p-2 rounded bg-gray-900 border border-gray-600 text-white">
            </div>
            <div class="flex flex-col w-32">
                <label class="text-xs text-orange-400 uppercase font-bold mb-1">Label (e.g. 10%)</label>
                <input type="text" id="display-${member.id}" value="${member.originalWeightDisplay || ''}" 
                       class="p-2 rounded bg-gray-900 border border-gray-600 text-white">
            </div>
        `;
        memberConfigInputs.appendChild(div);
    });
}

function initializeResultsList() {
    if (!resultsList) return;
    resultsList.innerHTML = '';
    for (let i = members.length; i >= 1; i--) {
        const li = document.createElement('li');
        li.innerHTML = `<span>Pick ${i}:</span> <span class="text-gray-400">Pending...</span>`;
        li.classList.add('bg-gray-700', 'text-gray-300');
        li.setAttribute('data-pick-num', i);
        resultsList.appendChild(li);
    }
}
function populateBalls() {
    if (!lotteryMachine) return;
    lotteryMachine.innerHTML = '';

    if (members.length === 0) {
        lotteryMachine.innerHTML = '<div class="text-xl font-semibold text-gray-400">No teams configured!</div>';
        if (runFullDraftBtn) runFullDraftBtn.disabled = true;
        return;
    }
    
    if (runFullDraftBtn) runFullDraftBtn.disabled = false;

    const ballsToRender = [];
    availableMembers.forEach(member => {
        const weight = member.weight || 0; 
        for (let i = 0; i < weight; i++) {
            ballsToRender.push({ teamId: member.id });
        }
    });

    if (ballsToRender.length === 0 && pickCounter > 0) {
        lotteryMachine.innerHTML = '<div class="text-xl font-semibold text-gray-400">All teams have been drawn!</div>';
        return;
    }
    const shuffledBalls = [...ballsToRender];
    for (let i = shuffledBalls.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffledBalls[i], shuffledBalls[j]] = [shuffledBalls[j], shuffledBalls[i]];
    }
const contentWidth = lotteryMachine.clientWidth;
    const mixingAreaHeight = lotteryMachine.clientHeight;
    const contentXStart = 0;
    const contentYStart = 0;
    
    shuffledBalls.forEach((ballData, index) => {
        const ball = document.createElement('div');
        ball.classList.add('ball');
        ball.dataset.teamId = ballData.teamId;
        ball.setAttribute('data-id', String(ballData.teamId));
        ball.style.position = 'absolute'; 

        const member = members.find(m => m.id === ballData.teamId); 
        if (member) {
            ball.style.backgroundColor = member.color || 'var(--accent-gold)';
            if (member.image) {
                ball.style.backgroundImage = `url('${member.image}')`;
            }
        }
       lotteryMachine.appendChild(ball);
        const ballWidth = ball.offsetWidth || 50; 
        const ballHeight = ball.offsetHeight || 50;
        const randomX = Math.random() * (contentWidth - ballWidth);
        const randomY = Math.random() * (mixingAreaHeight - ballHeight);
        ball.style.left = `${randomX + contentXStart}px`;
        ball.style.top = `${randomY + contentYStart}px`;
        const radius = Math.random() * (contentWidth / 4) + (contentWidth / 8);
        const duration = Math.random() * 8 + 4;
        const delay = Math.random() * -duration;
        ball.style.setProperty('--circle-radius', `${radius}px`);
        ball.style.animationName = 'circle-motion';
        ball.style.animationDuration = `${duration}s`;
        ball.style.animationDelay = `${delay}s`;
        ball.style.animationIterationCount = 'infinite';
        ball.style.animationTimingFunction = 'linear';
    });
}

async function runFullDraftSimulation() {
    if (drawing) return;
    drawing = true;

    const audio = document.getElementById('monacoAudio');
    if (!audio) return;
    if (runFullDraftBtn) {
        runFullDraftBtn.disabled = true;
        runFullDraftBtn.textContent = 'DRAFT IN PROGRESS...';
    }
    
    pickCounter = 8; 
    if (isDraftSaved) {
        if (resultsList) resultsList.innerHTML = '';
        availableMembers = members.map(member => ({ ...member }));
        populateBalls();
    } else {
        draftOrder = [];
    }
    const timestamps = [22, 54, 86, 118, 151, 183, 215, 250];
    for (let i = 0; i < timestamps.length; i++) {
        const targetTime = timestamps[i];
        while (audio.currentTime < targetTime) {
            await new Promise(resolve => setTimeout(resolve, 100));
            if (audio.paused && audio.currentTime > 0) break; 
        }
        await performSingleDraw();
    }
    if (!isDraftSaved) {
        await saveDraftOrderToSupabase(draftOrder);
        isDraftSaved = true;
    }  
    sessionStorage.setItem('hasSeenDraftAnimation', 'true');
    lotteryMachine.innerHTML = '';
    drawing = false;
    if (runFullDraftBtn) {
        runFullDraftBtn.disabled = false;
        runFullDraftBtn.textContent = 'RUN DRAFT'; 
    }
    
    if (currentPickLabel) currentPickLabel.textContent = "Draft Complete!";
}

async function performSingleDraw() {
    if (!currentPickLabel || !drawnTeamNameDisplay || !lotteryMachine) return;        
    currentPickLabel.textContent = `Drawing for Pick #${pickCounter}...`;
    drawnTeamNameDisplay.textContent = '';   
    lotteryMachine.querySelectorAll('.ball').forEach(ball => {
        ball.style.animationPlayState = 'paused';
    }); 

    await new Promise(resolve => setTimeout(resolve, 1500));              
    
    let drawnMember;
    if (isDraftSaved) {
        const savedPick = draftOrder.find(p => p.pick === pickCounter);
        if (savedPick) {
            drawnMember = members.find(
                m => String(m.id) === String(savedPick.teamId) || m.name === savedPick.member
            );
        }
    } else {
        drawnMember = drawWeightedMember();
    }

    if (drawnMember) {
        const allOddsItems = document.querySelectorAll('#teamOddsList li');
        allOddsItems.forEach(li => {
            const nameSpan = li.querySelector('.team-name');
            if (nameSpan && nameSpan.textContent.trim() === drawnMember.name.trim()) {
                li.classList.add('picked-team');
                console.log("Sidebar Update: Crossed out " + drawnMember.name);
            }
        });
        availableMembers = availableMembers.filter(m => String(m.id) !== String(drawnMember.id));
        const teamBalls = lotteryMachine.querySelectorAll(`.ball[data-id="${String(drawnMember.id)}"]`);
        if (teamBalls.length > 0) {
            teamBalls.forEach((ball) => {
                ball.style.left = '';
                ball.style.top = '';
                ball.style.transform = '';
                ball.classList.add('converging');
            });

            await new Promise(r => setTimeout(r, 900));
            for (let i = 1; i < teamBalls.length; i++) { teamBalls[i].remove(); }    
            
            const mainBall = teamBalls[0];
            mainBall.classList.add('merged');
            await new Promise(r => setTimeout(r, 1200));
            mainBall.classList.add('vanish');
            await new Promise(r => setTimeout(r, 800));
            mainBall.remove();
        }
        drawnTeamNameDisplay.textContent = drawnMember.name;
        showWinnerDrop(drawnMember.name, pickCounter);

        if (!isDraftSaved) {
            draftOrder.push({ 
                pick: pickCounter, 
                teamId: drawnMember.id, 
                member: drawnMember.name, 
                originalWeightDisplay: drawnMember.originalWeightDisplay 
            });
        }
        if (typeof resultsList !== 'undefined' && resultsList) {
            const pickElement = resultsList.querySelector(`li[data-pick-num="${pickCounter}"]`);
            if (pickElement) {
                pickElement.innerHTML = `<span>Pick ${pickCounter}:</span> <span>${drawnMember.name}</span>`;
                pickElement.classList.remove('bg-gray-700', 'text-gray-300');
                pickElement.classList.add('bg-green-500', 'text-white');
            }
        }
        lotteryMachine.querySelectorAll('.ball').forEach(ball => {
            ball.style.animationPlayState = 'running';
        });
        const waitTime = (pickCounter === 1) ? 2000 : 8500;
        await new Promise(resolve => setTimeout(resolve, waitTime));
    }
    pickCounter--; 
    
    if (pickCounter >= 1) {
        populateBalls();
    } else {
        console.log("Draft Complete! Closing curtains...");
        setTimeout(() => {
            const curtains = document.getElementById('curtainWrapper');
            if (curtains) {
                curtains.style.display = 'flex';
                setTimeout(() => {
                    curtains.classList.remove('open');
                    showMessage("The Draft is Complete! All picks are locked in.", "success");
                }, 50);
            }
        }, 1500); 
    }
}

    function showWinnerDrop(teamName, pickNum) {
    const overlay = document.getElementById('winnerOverlay');
    const winnerNameDisplay = document.getElementById('finalWinnerName');
    const winnerImage = document.getElementById('winnerImage');
    const title = overlay.querySelector('h1'); 

    if (overlay) {
        if (title) {
            title.textContent = pickNum === 1 ? "THE #1 PICK" : `PICK #${pickNum}`;
        }
        if (winnerNameDisplay) {
            winnerNameDisplay.textContent = teamName;
        }
        if (winnerImage) {
            const newSrc = (typeof pickImages !== 'undefined' && pickImages[pickNum]) 
                           ? pickImages[pickNum] 
                           : 'badbunny.png';
            winnerImage.src = newSrc;
        }

        overlay.classList.remove('hidden');
        overlay.style.display = 'flex';

        if (pickNum === 1) {
            // Pick #1 Styling
            overlay.style.backgroundColor = "rgba(0, 0, 0, 1)"; 
            winnerNameDisplay.style.fontSize = "clamp(3rem, 10vw, 6rem)";
            winnerNameDisplay.classList.add('animate-pulse');

            // --- THE 10 SECOND FINALE ---
            setTimeout(() => {
                closeWinnerOverlay();
            }, 10000); 

        } else {
            // Picks #8 through #2 Styling
            overlay.style.backgroundColor = "rgba(0, 0, 0, 0.95)";
            winnerNameDisplay.style.fontSize = ""; 
            winnerNameDisplay.classList.remove('animate-pulse'); 
            
            setTimeout(() => {
                closeWinnerOverlay();
            }, 8500);
        }
    }
}

function closeWinnerOverlay() {
    const overlay = document.getElementById('winnerOverlay');
    if (overlay) {
        overlay.classList.add('hidden');
        overlay.style.display = 'none';
    }
}

function drawWeightedMember() {
    if (availableMembers.length === 0) {
        return null;
    }
    const totalWeight = availableMembers.reduce((sum, member) => sum + member.weight, 0);
    let randomWeight = Math.random() * totalWeight;
    for (let i = 0; i < availableMembers.length; i++) {
        randomWeight -= availableMembers[i].weight;
        if (randomWeight <= 0) {
            const selectedMember = availableMembers[i];
            availableMembers.splice(i, 1);
            return selectedMember;
        }
    }    
    return availableMembers.pop();
}

    
function showResults() {
    if (resultsList) resultsList.style.display = 'block';
    updateUIFromCurrentState();
}

function updateUIFromCurrentState() {
    initializeResultsList();
    const sortedDraftOrder = [...draftOrder].sort((a, b) => a.pick - b.pick);
    sortedDraftOrder.forEach(item => {
        const originalMember = members.find(m => m.name === item.member);
        if (originalMember) {
            const oddsElement = teamOddsList.querySelector(`li[data-team-id="${originalMember.id}"]`);
            if (oddsElement) {
                oddsElement.classList.add('picked');
            }
        }
    
        const pickElement = resultsList.querySelector(`li[data-pick-num="${item.pick}"]`);
        if (pickElement) {
            pickElement.innerHTML = `<span>Pick ${item.pick}:</span> <span>${item.member} (${item.originalWeightDisplay})</span>`;
            pickElement.classList.remove('bg-gray-700', 'text-gray-300');
            pickElement.classList.add('bg-green-500', 'text-white');
        }
    });
}

function displayTeamOdds() {
    if (!teamOddsList) return;
    teamOddsList.innerHTML = '';
    const sortedMembers = [...members].sort((a, b) => b.weight - a.weight);

    sortedMembers.forEach(member => {
        const li = document.createElement('li');
        li.innerHTML = `<span>${member.name}:</span> <span>${member.originalWeightDisplay}</span>`;
        li.setAttribute('data-team-id', member.id);
        
        // Pre-check if already picked (useful for page refreshes)
        if (draftOrder.some(p => p.member === member.name)) {
            li.classList.add('picked');
        }
        
        teamOddsList.appendChild(li);
    });
}

function showMessage(message) {
    const messageBox = document.getElementById('messageBox');
    const messageText = document.getElementById('messageText');
    if (messageBox && messageText) {
        messageText.innerText = message;
        messageBox.style.display = 'flex';
        setTimeout(() => {
            messageBox.style.display = 'none';
        }, 5000);
    }
}

async function saveConfig() {
    const newMembers = [];
    let isValid = true;

    for (const member of members) {
        const nameInput = document.getElementById(`name-${member.id}`);
        const weightInput = document.getElementById(`weight-${member.id}`);
        const displayInput = document.getElementById(`display-${member.id}`);

        if (nameInput && weightInput && displayInput) {
            const newWeight = parseInt(weightInput.value, 10);
            const newName = nameInput.value.trim();
            const newDisplay = displayInput.value.trim();
            if (newName === '' || isNaN(newWeight) || newWeight <= 0) {
                showMessage('All team names must not be empty and weights must be positive.');
                isValid = false;
                return;
            }

            newMembers.push({
                id: member.id,
                name: newName,
                weight: newWeight,
                originalWeightDisplay: newDisplay || `${newWeight}%`
            });
        }
    }

    if (isValid && newMembers.length > 0) {
        const success = await saveMembersToSupabase(newMembers);
        
        if (success) {
            members = newMembers; 
            showMessage(`Configuration saved! The draft is ready.`);
            initializeDraftState(); 
        }
    } else if (newMembers.length === 0) {
        showMessage('At least one team must be configured.');
    }
}

async function fetchMembersFromSupabase() {
    console.log('Fetching members from Supabase...');
    const { data, error } = await supabase
        .from(SUPABASE_TABLE_NAME)
        .select('id, members_data')
        .order('members_data->>weight', { ascending: false });

    if (error) {
        console.error('Error fetching data from Supabase:', error);
        showMessage('Error fetching data from the database. Check console for details.');
        return [];
    }

    if (data && data.length > 0) {
        console.log('Data fetched successfully:', data);
        const members = data.map(item => ({
            id: item.id,
            name: item.members_data.name,
            weight: item.members_data.weight,
            originalWeightDisplay: item.members_data.originalWeightDisplay,
            color: item.members_data.color 
        }));
        console.log('After mapping, members array:', members, 'Length:', members.length);
        return members;
    } else {
        console.warn('No member data found in Supabase table.');
        return [];
    }
}

async function saveMembersToSupabase(newMembers) {
    console.log('Saving configuration to Supabase...', newMembers);

    const formattedData = newMembers.map(member => ({
        id: member.id,
        members_data: {
            name: member.name,
            weight: member.weight,
            originalWeightDisplay: member.originalWeightDisplay
        }
    }));
    
    const { data, error } = await supabase
        .from(SUPABASE_TABLE_NAME)
        .upsert(formattedData, { onConflict: 'id' })
        .select();

    if (error) {
        console.error('Error saving data to Supabase:', error);
        showMessage('Error saving configuration to the database. Check console for details.');
        return false;
    }
    console.log('Configuration saved successfully:', data);
    return true;
}

async function loadDraftOrderFromSupabase() {
    console.log('Checking for saved draft order...');
    const { data, error } = await supabase
        .from(SUPABASE_ORDERS_TABLE_NAME)
        .select('order_data')
        .order('order_data->>pick', { ascending: false });
    
    if (error) {
        console.error('Error fetching draft order:', error);
        return null;
    }

    if (data && data.length > 0) {
        console.log('Draft order found in Supabase:', data);
        return data.map(item => item.order_data);
    }

    console.log('No draft order found in the database.');
    return null;
}

/* --- DRAFT MANAGEMENT FUNCTIONS --- */
async function resetDraft() {
    const confirmed = confirm("WARNING: This will delete the saved draft order from the database. This cannot be undone. Are you sure you want to reset for a new run?");
    
    if (!confirmed) return;

    try {
        const { error } = await supabase
            .from('draft_order')
            .delete()
            .neq('id', 0); 

        if (error) throw error;
        sessionStorage.removeItem('hasSeenDraftAnimation');
        draftOrder = [];
        isDraftSaved = false;
        showMessage("Draft has been reset! Ready for a new lottery.");
        initializeDraftState();

    } catch (err) {
        console.error("Error during reset:", err);
        showMessage("Error resetting draft. Check the console.");
    }
}

   function updateOddsDisplay() {
    const teamOddsList = document.getElementById('teamOddsList');
    if (!teamOddsList || !members || members.length === 0) return;
    teamOddsList.innerHTML = '';

    // Sort teams by weight (highest odds first)
    const sortedMembers = [...members].sort((a, b) => b.weight - a.weight);

    sortedMembers.forEach(m => {
        const li = document.createElement('li');
        li.setAttribute('data-id', m.id); 
        
        // KEEP YOUR STYLING: These classes make it look good
        li.className = "flex justify-between items-center p-4 mb-3 bg-slate-800 rounded-xl border-l-4 border-yellow-500 shadow-lg transition-all duration-700";
        
        li.innerHTML = `
            <span class="team-name font-bold text-white uppercase tracking-tight">${m.name}</span>
            <span class="odds-percent font-mono text-white text-lg">${m.weight}%</span>
        `;
        
        // PERSISTENCE LOGIC: Check if this team was already drawn (for page refreshes)
        const alreadyPicked = draftOrder.find(p => 
            String(p.teamId) === String(m.id) || p.member === m.name
        );
        
        if (alreadyPicked) {
            li.classList.add('picked-team');
        }

        teamOddsList.appendChild(li);
    });
    
    console.log("Odds display updated with " + members.length + " teams.");
}

</script>
</body>
</html>
