<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="data:,">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantasy Football Draft Lottery</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <style>


    :root {
        --primary-dark: #1e3159; 
        --accent-gold: #FFD700; 
        --light-text: #f0f4f8; 
        --container-bg: #2a3d60; 
        --section-bg: #3c5283; 
        --highlight-blue: #6495ed; 
    }

    body {
        font-family: 'Inter', sans-serif;
        background-color: var(--primary-dark); /* Using the deep blue for the body background */
        color: var(--light-text);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        padding: 2rem 1rem; /* Add padding for mobile screens */
        box-sizing: border-box;
        background-image:
            radial-gradient(circle at 10% 90%, rgba(255, 215, 0, 0.05) 0%, transparent 50%),
            radial-gradient(circle at 90% 10%, rgba(255, 215, 0, 0.05) 0%, transparent 50%); /* Subtle gold particles in the background */
    }

    /* Main container for the lottery application */
    .container {
        background-color: #2a3d60; /* A slightly lighter shade of the blue */
        border-radius: 2rem;
        padding: 2.5rem;
        box-shadow:
            0 25px 50px -12px rgba(0, 0, 0, 0.5),
            inset 0 0 30px rgba(0, 0, 0, 0.2);
        text-align: center;
        width: 100%;
        max-width: 950px;
        border: 4px solid var(--accent-gold);
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    /* Main headings */
    h1, h2 {
        font-family: 'Bebas Neue', sans-serif;
        letter-spacing: 0.1em;
        text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
        -webkit-text-stroke: 1px var(--primary-dark);
    }
    
    /* Gradient for titles */
    h1 {
        font-size: 3.5rem;
        margin-bottom: 0.5rem;
        background: linear-gradient(90deg, #FFD700, #FFEF9F);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    h2 {
        font-size: 2.5rem;
        margin-top: 2rem;
        margin-bottom: 1.5rem;
        color: var(--light-text);
    }

    .team-odds-section {
        margin-top: 2rem;
        background-color: var(--section-bg);
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.4);
        border: 2px solid var(--highlight-blue);
        width: 100%;
    }

    .team-odds-list {
        list-style: none;
        padding: 0;
        margin-top: 1rem;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
    }

    .team-odds-list li {
        background-color: var(--container-bg);
        color: var(--light-text);
        padding: 1rem;
        border-radius: 0.75rem;
        font-size: 1rem;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-left: 5px solid var(--accent-gold);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .team-odds-list li:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4);
    }

    .team-odds-list li span:last-child {
        color: var(--accent-gold);
        font-weight: 900;
        font-size: 1.1rem;
    }

    /* Results section */
    .results-section {
        margin-top: 2.5rem;
        background-color: var(--section-bg);
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.4);
        border: 2px solid var(--highlight-blue);
        width: 100%;
    }

    .results-list {
        list-style: none;
        padding: 0;
        margin-top: 1.5rem;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .results-list li {
        background-color: var(--container-bg);
        color: var(--light-text);
        padding: 1rem;
        border-radius: 0.75rem;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-left: 5px solid var(--highlight-blue);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        transition: transform 0.2s ease;
    }

    .results-list li:hover {
        transform: scale(1.03);
    }

    .results-list li span:first-child {
        font-size: 1.2rem;
        margin-right: 0.5rem;
    }

    .results-list li span:last-child {
        font-size: 1.4rem;
        color: var(--accent-gold);
        font-family: 'Bebas Neue', sans-serif;
    }

    @keyframes ballAgitation {
0% { transform: translate(0, 0) rotate(0deg); }
20% { transform: translate(10px, -15px) rotate(10deg); } /* Move up slightly /
40% { transform: translate(-12px, 10px) rotate(-15deg); } / Move down slightly /
60% { transform: translate(8px, -10px) rotate(5deg); } / Move up again, less height /
80% { transform: translate(-5px, 5px) rotate(-5deg); } / Move down again, less height */
100% { transform: translate(0, 0) rotate(0deg); }
}

    .lottery-machine {
        position: relative;
        width: 80vw;
        max-width: 400px;
        aspect-ratio: 1;
        border-radius: 50%;
        margin: 3rem auto;
        overflow: hidden;
        border: 15px solid #a0b3c8;
        background: linear-gradient(180deg, #5b6d90, #2c3e59);
        box-shadow:
            0 0 50px rgba(255, 215, 0, 0.4),
            inset 0 0 80px rgba(255, 255, 255, 0.3),
            inset 0 0 120px rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
        padding: 20px;
        z-index: 0;
    }

    .lottery-machine::after {
        content: '';
        position: absolute;
        top: -30px;
        left: 50%;
        transform: translateX(-50%);
        width: 150px;
        height: 80px;
        background: #121f3d;
        border-radius: 50px 50px 0 0;
        border-bottom: 10px solid #a0b3c8;
        box-shadow: inset 0 -10px 25px rgba(0, 0, 0, 0.9);
        z-index: 5;
        pointer-events: none;
    }

  .ball {
    position: absolute;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    font-weight: 900;
    color: #ffffff;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 1); 
    font-size: 1.1rem;
    box-shadow: 0 5px 10px rgba(0, 0, 0, 0.5);
    border: 2px solid var(--accent-gold);
    background-size: cover;
    background-position: center;
    z-index: 2;
    transition: all 0.8s ease-out;
}

    .ball:nth-child(1) { background-image: url('badbunny4.png'); }
    .ball:nth-child(2) { background-image: url('badbunny.png'); }
    .ball:nth-child(3) { background-image: url('badbunny1.png'); }
    .ball:nth-child(4) { background-image: url('badbunny2.png'); }
    .ball:nth-child(5) { background-image: url('badbunny3.png'); }
    .ball:nth-child(6) { background-image: url('badbunny6.png'); }
    .ball:nth-child(7) { background-image: url('badbunny7.png'); }
    .ball:nth-child(8) { background-image: url('badbunny9.png'); }
  

    .ball.selected-for-shoot, .ball.drawn {
        animation: none !important; /* This is correct, it stops agitation when selected or drawn */
    }

   .ball.selected-for-shoot {
    background-image: none !important;
    background: radial-gradient(circle at top left, #fff 0%, var(--accent-gold) 100%) !important;
    box-shadow: 0 0 30px var(--accent-gold), 0 0 10px #fff;
    z-index: 50;
    transform: scale(1.3);
    transition: top 0.7s cubic-bezier(0.68, -0.55, 0.27, 1.55), 
                left 0.7s cubic-bezier(0.68, -0.55, 0.27, 1.55), 
                transform 0.3s ease;
   }
  .ball.drawn {
        transform: translateY(-400px) scale(0.1);
        opacity: 0;
        transition: transform 1.5s ease-in, opacity 1.5s ease-out;
        pointer-events: none;
        z-index: 1;
    }

    .drawn-ball-display {
        min-height: 120px;
        background-color: var(--section-bg);
        border-radius: 1.5rem;
        padding: 1.5rem;
        margin-top: 2rem;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.4);
        border: 4px dashed var(--accent-gold);
        position: relative;
        overflow: hidden;
    }
    
    .drawn-ball-display::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border-radius: 1.5rem;
        border: 4px solid var(--accent-gold);
        opacity: 0.5;
        animation: glowingBorder 1.5s infinite alternate ease-in-out;
        pointer-events: none;
    }

    @keyframes glowingBorder {
        from {
            box-shadow: 0 0 10px var(--accent-gold), 0 0 20px var(--accent-gold), 0 0 30px var(--accent-gold);
            opacity: 0.5;
        }
        to {
            box-shadow: 0 0 20px var(--accent-gold), 0 0 40px var(--accent-gold), 0 0 60px var(--accent-gold);
            opacity: 0.8;
        }
    }


@keyframes bounce {
    0%   { transform: translateY(0); }
    50%  { transform: translateY(10px); } /* Adjust this value for bounce height */
    100% { transform: translateY(0); }
}

@keyframes circle-motion {
    0% {
        transform: rotate(0deg) translateX(var(--circle-radius)) rotate(0deg);
    }
    100% {
        transform: rotate(360deg) translateX(var(--circle-radius)) rotate(-360deg);
    }
}
    .drawn-ball-display .current-pick-label {
        font-size: 1.75rem;
        font-weight: bold;
        color: var(--light-text);
        margin-bottom: 0.5rem;
        font-family: 'Bebas Neue', sans-serif;
        letter-spacing: 0.1em;
    }
    
    .drawn-ball-display .drawn-team-name {
        font-size: 3.5rem;
        font-weight: 900;
        text-transform: uppercase;
        font-family: 'Bebas Neue', sans-serif;
        color: #FFD700;
        text-shadow: 2px 2px 0px #000, rgba(0, 0, 0, 0.7);
        letter-spacing: 0.1em;
            }

    .btn {
        background: linear-gradient(90deg, #FFD700, #FFEF9F);
        color: var(--primary-dark);
        padding: 1rem 2rem;
        border-radius: 1rem;
        font-weight: 900;
        font-size: 1.5rem;
        border: none;
        cursor: pointer;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        margin-top: 2rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-family: 'Bebas Neue', sans-serif;
        text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
    }

    .btn:hover:not(:disabled) {
        transform: translateY(-5px) scale(1.05);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.6);
        background: linear-gradient(90deg, #FFEF9F, #FFD700); /* Inverted gradient on hover */
    }

    .btn:disabled {
        background: #6a748c;
        color: #b0b8c8;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
    }

    /* Message Box Styling */
    .message-box {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: var(--container-bg);
        color: var(--light-text);
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
        z-index: 1000;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-width: 350px;
        text-align: center;
        border: 3px solid var(--accent-gold);
    }

    .message-box button {
        margin-top: 20px;
        padding: 10px 20px;
        background-color: var(--highlight-blue);
        color: var(--light-text);
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        font-size: 1.1rem;
        transition: background-color 0.2s ease, transform 0.2s ease;
    }

    .message-box button:hover {
        background-color: #5a8bd4;
        transform: translateY(-2px);
    }


    @media (max-width: 768px) {
        h1 {
            font-size: 2.5rem;
        }
        h2 {
            font-size: 2rem;
        }
        .container {
            padding: 1.5rem;
        }
        .drawn-ball-display .drawn-team-name {
            font-size: 2.2rem;
        }
        .lottery-machine {
            width: 75vw;
            max-width: 300px;
            margin: 2rem auto;
        }
        .ball {
            width: 45px;
            height: 45px;
            font-size: 1rem;
        }
        .btn {
            font-size: 1.3rem;
            padding: 0.8rem 1.6rem;
        }
    }

  @media (max-width: 480px) {
    h1 {
        font-size: 2rem;
    }
    h2 {
        font-size: 1.5rem;
    }
    .container {
        padding: 1rem;
        border-radius: 1.5rem;
    }
    .drawn-ball-display .drawn-team-name {
        font-size: 1.8rem;
    }
    .team-odds-list,
    .results-list {
        grid-template-columns: 1fr;
        gap: 0.75rem;
    }
    .lottery-machine {
        width: 90vw;
        min-height: 250px;
    }
}

.picked {
    text-decoration: line-through;
    text-decoration-color: red;
    text-decoration-thickness: 6px;
    opacity: 0.5;
}

.audio-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.95);
    color: #FFD700;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999; /* Make sure it's on top of everything */
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2.5rem;
    text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.8);
    cursor: pointer;
    text-align: center;
    padding: 20px;
    box-sizing: border-box;
    transition: opacity 0.5s ease-in-out;
}

.audio-overlay.hidden {
    opacity: 0;
    pointer-events: none; /* Make it unclickable when hidden */
}

.overlay-content {
    animation: pulse 2s infinite ease-in-out;
}

@keyframes pulse {
    0% { transform: scale(1); opacity: 0.8; }
    50% { transform: scale(1.05); opacity: 1; }
    100% { transform: scale(1); opacity: 0.8; }
}

.hidden {
    display: none !important; /* Use !important to ensure it overrides other display properties */
}

#memberConfigInputs input {
    background-color: #0f172a !important; /* Dark blue background */
    color: #ffffff !important;            /* Pure white text */
    border: 1px solid #FFD700 !important;  /* Gold border */
    padding: 8px;
    border-radius: 6px;
    margin-bottom: 10px;
    width: 100%; /* Helps with mobile layout */
    max-width: 200px;
}

#memberConfigInputs label {
    color: #FFD700 !important; /* Gold labels for Team/Weight */
    font-weight: bold;
    display: block;
    margin-top: 10px;
    font-size: 0.85rem;
}

.input-group {
    border-bottom: 1px solid rgba(255, 215, 0, 0.2);
    padding-bottom: 15px;
    margin-bottom: 15px;
}
      
    </style>
    </head>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>


<body>
<div class="container">

   <h1 class="text-5xl md:text-6xl mb-8 tracking-widest uppercase"
    style="
        font-family: 'Bebas Neue', sans-serif;
        color: #FFD700;
        letter-spacing: 0.1em;
    ">
    TCWR DY-NASTY Draft Lottery
</h1>

    <div class="lottery-machine" id="lotteryMachine">
        <div class="text-xl font-semibold text-gray-400">Loading draft state...</div>
    </div>

    <div class="drawn-ball-display" id="drawnBallDisplay">
        <div class="current-pick-label" id="currentPickLabel">Ready to Draw for Pick #...</div>
        <div class="drawn-team-name" id="drawnTeamName"></div>
    </div>

    <button class="btn" id="runFullDraftBtn">Run Draft</button>
    
    <div class="results-section">
        <h2 class="text-4xl mb-6 tracking-wide uppercase"
            style="
                font-family: 'Bebas Neue', sans-serif;
                color: #FFD700;
                text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.8);
                letter-spacing: 2px;
            ">
            Draft Order Results
        </h2>
        <ul class="results-list" id="resultsList">
            </ul>
    </div>

    <div class="team-odds-section">
        <h2 class="text-4xl mb-6 tracking-wide uppercase" 
            style="
                font-family: 'Bebas Neue', sans-serif;
                color: #FFD700;
                text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.8);
                letter-spacing: 2px;
            ">
            Team Odds
        </h2>
        <ul id="teamOddsList" class="team-odds-list">
            </ul>
    </div>

<div class="commissioner-tools">
    <h2 class="text-2xl font-bold mb-4 text-orange-500">Commissioner Tools</h2>
    <form id="commissionerLogin">
        <input type="password" id="commissionerPassword" placeholder="Enter Password" 
               class="p-3 rounded-md bg-gray-900 border-2 border-yellow-600 text-white placeholder-gray-500 focus:ring-2 focus:ring-yellow-500">
        <button type="submit" id="unlockCommissionerBtn" class="btn mt-4 bg-blue-600 hover:bg-blue-700 text-white">Unlock</button>
    </form>

    <div id="commissionerPanel" class="hidden">
        <p class="text-sm text-gray-400 mb-4">Update team names and their weighted odds below.</p>
        
        <div id="memberConfigInputs" class="space-y-2"></div>

        <button id="saveConfigBtn" class="btn mt-4 bg-green-600 hover:bg-green-700 text-white font-bold">Save Configuration</button>
        <button id="resetDraftBtn" class="btn mt-4 ml-2 bg-red-600 hover:bg-red-700 text-white font-bold">Reset Draft</button>
    </div>
</div>

        <div id="messageBox" class="message-box">
        <p id="messageText"></p>
        <button onclick="document.getElementById('messageBox').style.display = 'none'">OK</button>
    </div>

</div> <div id="audioOverlay" class="audio-overlay">
    <div class="overlay-content">
        <div class="explanation-text" style="max-width: 800px; padding: 2rem; border-radius: 1rem; text-shadow: 1px 1px 4px rgba(0,0,0,0.7); text-align: center;">
            <h3 style="font-family: 'Bebas Neue', sans-serif; font-size: 2.5rem; letter-spacing: 0.1em; margin-bottom: 1rem; color: #FFD700; text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.8);">
                How the Lottery Works: Reverse Order Reveal
            </h3>
            <p style="font-size: 1.1rem; line-height: 1.5; margin-bottom: 1.5rem;">
                Our lottery builds suspense by revealing the draft order in reverse, from Pick #8 down to the highly anticipated Pick #1.
                <br/><br/>
                Here’s the key rule: Once a team is drawn from the machine, they are awarded the current pick and are **eliminated from all future draws**.
            </p>
            
            <div style="text-align: left; margin: 0 auto; line-height: 1.6; max-width: 500px;">
                <p style="font-size: 1.1rem; margin-bottom: 0.5rem; font-weight: bold;">This means:</p>
                <ul style="list-style: disc; list-style-position: inside; padding-left: 1rem; font-size: 1rem;">
                    <li>
                        <strong style="color: #FFD700;">Teams with the highest odds</strong> have the highest chance of being drawn for the very first pick revealed... **Pick #8**.
                    </li>
                    <li>
                        <strong style="color: #FFD700;">Teams with the lowest odds</strong> are long shots, but if they get lucky and avoid being picked early, their odds of winning a top pick like #1 increase with every round.
                    </li>
                </ul>
            </div>
            <p style="font-size: 1rem; margin-top: 1.5rem; font-style: italic;">
                The suspense builds as the most likely teams are eliminated, leaving a shot at the jackpot for the long shots.
            </p>
        </div>
        
        <p style="margin-top: 2.5rem; font-size: 1.8rem; font-weight: bold; text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.8);" class="animate-pulse">
            Click anywhere to start the simulator!
        </p>
    </div>
</div>

 
<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

const COMMISSIONER_PASSWORD = 'Asher'; 
const SUPABASE_URL = 'https://jheqfwykhvyngfqawknr.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpoZXFmd3lraHZ5bmdmcWF3a25yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ5NDE3MjEsImV4cCI6MjA2MDUxNzcyMX0.LLWSmRdZW_5XD2Z8NqGB5BTP3hAtk63pOnZiSckf7BM';
const SUPABASE_TABLE_NAME = 'draft_configs';
const SUPABASE_ORDERS_TABLE_NAME = 'draft_orders';
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let members = []; 
let availableMembers = [];
let draftOrder = [];
let drawing = false;
let pickCounter = 0;
let isDraftSaved = false;

let espnAudio = null;
let crowdShoutAudio = null;
let disappointmentAudio = null;
let cheeringAudio = null;
let crowdCheersAudio = null;
let audioTimeout;

const lotteryMachine = document.getElementById('lotteryMachine');
const runFullDraftBtn = document.getElementById('runFullDraftBtn');
const currentPickLabel = document.getElementById('currentPickLabel');
const drawnTeamNameDisplay = document.getElementById('drawnTeamName');
const resultsList = document.getElementById('resultsList');
const teamOddsList = document.getElementById('teamOddsList');
const audioOverlay = document.getElementById('audioOverlay');
const commissionerLogin = document.getElementById('commissionerLogin');
const commissionerPasswordInput = document.getElementById('commissionerPassword');
const unlockCommissionerBtn = document.getElementById('unlockCommissionerBtn');
const commissionerPanel = document.getElementById('commissionerPanel');
const memberConfigInputs = document.getElementById('memberConfigInputs');
const saveConfigBtn = document.getElementById('saveConfigBtn');
const resetDraftBtn = document.getElementById('resetDraftBtn');

// --- INITIALIZATION ---

document.addEventListener('DOMContentLoaded', () => {
    initializeDraftState();    
    if (runFullDraftBtn) runFullDraftBtn.addEventListener('click', runFullDraftSimulation);
    if (unlockCommissionerBtn) unlockCommissionerBtn.addEventListener('click', handleCommissionerUnlock);
    if (commissionerLogin) commissionerLogin.addEventListener('submit', handleCommissionerUnlock);
    if (saveConfigBtn) saveConfigBtn.addEventListener('click', (e) => { e.preventDefault(); saveConfig(); });
    if (resetDraftBtn) resetDraftBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        if (await clearDraftOrderFromSupabase()) initializeDraftState();
    });
    if (audioOverlay) audioOverlay.addEventListener('click', handleFirstInteraction, { once: true });
    document.addEventListener('keydown', handleFirstInteraction, { once: true });
});

function populateBalls() {
    if (!lotteryMachine) return;
    lotteryMachine.innerHTML = '';    
    
    const bunnyImages = ['badbunny.png', 'badbunny1.png', 'badbunny2.png', 'badbunny3.png', 'badbunny4.png', 'badbunny6.png', 'badbunny7.png', 'badbunny9.png'];
    const ballsToRender = [];

    console.log("Starting to populate balls. Available members:", availableMembers.length);

    availableMembers.forEach(member => {
        // Force the weight to be a number. If it's 10%, we want 10 balls.
        const weightValue = parseInt(member.weight);
        
        for (let i = 0; i < weightValue; i++) {
            ballsToRender.push({ teamId: member.id });
        }
    });

    console.log("Total balls to create:", ballsToRender.length);

    const machineRect = lotteryMachine.getBoundingClientRect();
    const maxRadius = (machineRect.width / 2) - 40; 

    ballsToRender.sort(() => Math.random() - 0.5).forEach((ballData) => {
        const ball = document.createElement('div');
        ball.classList.add('ball');
        ball.dataset.teamId = ballData.teamId;

        const memberIndex = members.findIndex(m => m.id === ballData.teamId);
        ball.style.backgroundImage = `url('${bunnyImages[memberIndex % bunnyImages.length]}')`;    
        
        lotteryMachine.appendChild(ball);

        const randomRadius = Math.random() * maxRadius;
        const duration = Math.random() * 2 + 1.5; // Made it slightly faster
        const delay = Math.random() * -5;

        ball.style.setProperty('--circle-radius', `${randomRadius}px`);
        ball.style.left = `calc(50% - 25px)`;
        ball.style.top = `calc(50% - 25px)`;
        ball.style.animation = `
            circle-motion ${duration}s linear ${delay}s infinite, 
            ballAgitation 0.3s ease-in-out infinite
        `;
    });
}

  function drawWeightedMember() {
    if (isDraftSaved && draftOrder.length > 0) {
        const pick = draftOrder.find(p => p.pick === pickCounter);
        if (pick) {
            const idx = availableMembers.findIndex(m => m.name === pick.member);
            if (idx !== -1) availableMembers.splice(idx, 1);
            
            return {
                id: members.find(m => m.name === pick.member)?.id,
                name: pick.member,
                originalWeightDisplay: pick.originalWeightDisplay
            };
        }
    }

    if (availableMembers.length === 0) return null;
    const totalWeight = availableMembers.reduce((sum, m) => sum + (parseInt(m.weight) || 0), 0);
    let randomWeight = Math.random() * totalWeight;
    for (let i = 0; i < availableMembers.length; i++) {
        const currentWeight = parseInt(availableMembers[i].weight) || 0;
        randomWeight -= currentWeight;
        if (randomWeight <= 0) {
            const selected = availableMembers[i];
            availableMembers.splice(i, 1);
            return selected;
        }
    }
    return availableMembers.pop();
}
async function performSingleDraw() {
    if (!currentPickLabel || !drawnTeamNameDisplay || !lotteryMachine) return;
    currentPickLabel.textContent = `Drawing for Pick #${pickCounter}...`;
    drawnTeamNameDisplay.textContent = '';
    lotteryMachine.querySelectorAll('.ball').forEach(ball => {
        ball.style.animationPlayState = 'paused';
    });
    
    await new Promise(resolve => setTimeout(resolve, 2000));
    const drawnMember = drawWeightedMember();

    if (drawnMember) {
        playPickAudio(pickCounter);
        
        const teamBalls = lotteryMachine.querySelectorAll(`.ball[data-team-id="${drawnMember.id}"]`);

        if (teamBalls.length > 0) {
            const machineRect = lotteryMachine.getBoundingClientRect();
            const targetX = (machineRect.width / 2);
            const targetY = 10;

            teamBalls.forEach(ballElement => {
                ballElement.style.left = `${targetX - (ballElement.offsetWidth / 2)}px`;
                ballElement.style.top = `${targetY}px`;
                ballElement.classList.add('selected-for-shoot');
            });

            await new Promise(resolve => setTimeout(resolve, 1000));

            drawnTeamNameDisplay.textContent = drawnMember.name;
            
            await new Promise(resolve => setTimeout(resolve, 1500));

            teamBalls.forEach(ballElement => {
                ballElement.classList.remove('selected-for-shoot');
                ballElement.classList.add('drawn');
            });
            
            await new Promise(resolve => setTimeout(resolve, 1500));
            teamBalls.forEach(ballElement => {
                if (ballElement && ballElement.parentNode) {
                    ballElement.remove();
                }
            });
        } else {
            console.warn(`Could not find visual balls for drawn member: ${drawnMember.name}.`);
            drawnTeamNameDisplay.textContent = drawnMember.name;
            await new Promise(resolve => setTimeout(resolve, 1500));
        }
        if (!isDraftSaved) {
            draftOrder.push({ pick: pickCounter, member: drawnMember.name, originalWeightDisplay: drawnMember.originalWeightDisplay });
        }
        const pickElement = resultsList.querySelector(`li[data-pick-num="${pickCounter}"]`);
        if (pickElement) {
            pickElement.innerHTML = `<span>Pick ${pickCounter}:</span> <span>${drawnMember.name} (${drawnMember.originalWeightDisplay})</span>`;
            pickElement.classList.remove('bg-gray-700', 'text-gray-300');
            pickElement.classList.add('bg-green-500', 'text-white');
        }

        const oddsElement = teamOddsList.querySelector(`li[data-team-id="${drawnMember.id}"]`);
        if (oddsElement) {
            oddsElement.classList.add('picked');
        }
    
        lotteryMachine.querySelectorAll('.ball').forEach(ball => {
            ball.style.animationPlayState = 'running';
        });
    } else {
        console.warn("No more members to draw during performSingleDraw.");
    }
}

async function runFullDraftSimulation() {
    if (drawing) return;
    drawing = true;
    pickCounter = members.length;

    if (runFullDraftBtn) {
        runFullDraftBtn.disabled = true;
        runFullDraftBtn.textContent = 'Drawing...';
    }

    if (isDraftSaved) {
        resultsList.style.display = 'none';
        availableMembers = members.map(m => ({ ...m }));
        document.querySelectorAll('.team-odds-list li').forEach(li => li.classList.remove('picked'));
        populateBalls();
    }
    
    initializeResultsList();

    while (pickCounter >= 1) {
        await performSingleDraw();
        pickCounter--; 
    }
    
    if (!isDraftSaved) {
        await saveDraftOrderToSupabase(draftOrder);
        isDraftSaved = true;
    }
    
    sessionStorage.setItem('hasSeenDraftAnimation', 'true');
    showResults();
    drawing = false;
    runFullDraftBtn.disabled = false;
    runFullDraftBtn.textContent = 'Replay Draft Animation';
    currentPickLabel.textContent = "Draft Complete!";
}

// --- HELPER UI FUNCTIONS ---

function updateUIForPick(member) {
    const pickElement = resultsList.querySelector(`li[data-pick-num="${pickCounter}"]`);
    if (pickElement) {
        pickElement.innerHTML = `<span>Pick ${pickCounter}:</span> <span>${member.name} (${member.originalWeightDisplay})</span>`;
        pickElement.classList.replace('bg-gray-700', 'bg-green-500');
        pickElement.classList.replace('text-gray-300', 'text-white');
    }
    const oddsElement = teamOddsList.querySelector(`li[data-team-id="${member.id}"]`);
    if (oddsElement) oddsElement.classList.add('picked');
}

function initializeResultsList() {
    resultsList.innerHTML = '';
    for (let i = members.length; i >= 1; i--) {
        const li = document.createElement('li');
        li.innerHTML = `<span>Pick ${i}:</span> <span class="text-gray-400">Pending...</span>`;
        li.className = 'bg-gray-700 text-gray-300 p-2 rounded mb-2 flex justify-between';
        li.setAttribute('data-pick-num', i);
        resultsList.appendChild(li);
    }
}

// --- AUTH / SUPABASE --- (Kept from your original)

async function initializeDraftState() {
    members = await fetchMembersFromSupabase();
    if (members.length === 0) return;

    const savedOrder = await loadDraftOrderFromSupabase();
    if (savedOrder) {
        isDraftSaved = true;
        draftOrder = savedOrder.sort((a, b) => a.pick - b.pick);
        if (sessionStorage.getItem('hasSeenDraftAnimation')) {
            showResults();
            runFullDraftBtn.textContent = 'Replay Draft Animation';
        } else {
            setupFreshDraft();
        }
    } else {
        setupFreshDraft();
    }
    initializeMemberConfigInputs();
}

function setupFreshDraft() {
    availableMembers = members.map(m => ({ ...m }));
    pickCounter = members.length;
    populateBalls();
    displayTeamOdds();
    initializeResultsList();
}

// ... Rest of your Supabase Fetch/Save and Audio functions remain the same ...
// [Include your existing fetchMembersFromSupabase, saveConfig, etc. below this line]

async function fetchMembersFromSupabase() {
    const { data, error } = await supabase.from(SUPABASE_TABLE_NAME).select('id, members_data');
    if (error) return [];
    return data.map(item => ({
        id: item.id,
        name: item.members_data.name,
        weight: item.members_data.weight,
        originalWeightDisplay: item.members_data.originalWeightDisplay
    }));
}

async function loadDraftOrderFromSupabase() {
    const { data } = await supabase.from(SUPABASE_ORDERS_TABLE_NAME).select('order_data');
    return data ? data.map(item => item.order_data) : null;
}

async function saveDraftOrderToSupabase(order) {
    const formatted = order.map(p => ({ id: `pick_${p.pick}`, order_data: p }));
    await supabase.from(SUPABASE_ORDERS_TABLE_NAME).upsert(formatted);
}

async function clearDraftOrderFromSupabase() {
    const { error } = await supabase.from(SUPABASE_ORDERS_TABLE_NAME).delete().not('id', 'is', null);
    sessionStorage.removeItem('hasSeenDraftAnimation');
    return !error;
}

function handleFirstInteraction() {
    if (!espnAudio) {
        espnAudio = new Audio('Espnprimetime.m4a');
        espnAudio.loop = true;
        espnAudio.volume = 0.5;
        crowdShoutAudio = new Audio('crowd-shouting-6325.mp3');
        disappointmentAudio = new Audio('disappointment.mp3');
        cheeringAudio = new Audio('cheering.mp3');
        crowdCheersAudio = new Audio('crowd-cheers-312833.mp3');
    }
    espnAudio.play();
    audioOverlay.style.display = 'none';
}

function playPickAudio(pick) {
    [crowdShoutAudio, disappointmentAudio, cheeringAudio].forEach(a => { if(a) { a.pause(); a.currentTime = 0; }});
    let play;
    if (pick <= 4) play = cheeringAudio;
    else if (pick <= 7) play = disappointmentAudio;
    else play = crowdShoutAudio;
    if (play) play.play();
}

function displayTeamOdds() {
    teamOddsList.innerHTML = '';
    [...members].sort((a,b) => b.weight - a.weight).forEach(m => {
        const li = document.createElement('li');
        li.innerHTML = `<span>${m.name}:</span> <span>${m.originalWeightDisplay}</span>`;
        li.setAttribute('data-team-id', m.id);
        teamOddsList.appendChild(li);
    });
}

function showResults() {
    resultsList.style.display = 'block';
    updateUIFromCurrentState();
}

function updateUIFromCurrentState() {
    initializeResultsList();
    draftOrder.forEach(item => {
        pickCounter = item.pick;
        updateUIForPick({ name: item.member, originalWeightDisplay: item.originalWeightDisplay, id: members.find(m => m.name === item.member)?.id });
    });
}

function handleCommissionerUnlock(e) {
    if (e) e.preventDefault();
    if (commissionerPasswordInput.value === COMMISSIONER_PASSWORD) {
        commissionerPanel.classList.remove('hidden');
        commissionerLogin.classList.add('hidden');
    }
}

function initializeMemberConfigInputs() {
    memberConfigInputs.innerHTML = '';
    members.forEach(m => {
        const div = document.createElement('div');
        div.innerHTML = `<label>${m.name}</label><input type="number" id="weight-${m.id}" value="${m.weight}" class="admin-input">`;
        memberConfigInputs.appendChild(div);
    });
}

async function saveConfig() {
    const newMembers = members.map(m => ({
        id: m.id,
        members_data: { name: m.name, weight: parseInt(document.getElementById(`weight-${m.id}`).value), originalWeightDisplay: `${document.getElementById(`weight-${m.id}`).value}%` }
    }));
    await supabase.from(SUPABASE_TABLE_NAME).upsert(newMembers);
    location.reload();
}

</script>
 
</body>
</html>
