<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantasy Football Draft Lottery</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    
    <style>


    :root {
        --primary-dark: #1e3159; /* Deep Blue */
        --accent-gold: #FFD700; /* Gold */
        --light-text: #f0f4f8; /* Light gray for contrast */
        --container-bg: #2a3d60; /* Slightly lighter blue for containers */
        --section-bg: #3c5283; /* Muted blue for sections */
        --highlight-blue: #6495ed; /* Cornflower blue */
    }

    body {
        font-family: 'Inter', sans-serif;
        background-color: var(--primary-dark); /* Using the deep blue for the body background */
        color: var(--light-text);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        padding: 2rem 1rem; /* Add padding for mobile screens */
        box-sizing: border-box;
        background-image:
            radial-gradient(circle at 10% 90%, rgba(255, 215, 0, 0.05) 0%, transparent 50%),
            radial-gradient(circle at 90% 10%, rgba(255, 215, 0, 0.05) 0%, transparent 50%); /* Subtle gold particles in the background */
    }

    /* Main container for the lottery application */
    .container {
        background-color: #2a3d60; /* A slightly lighter shade of the blue */
        border-radius: 2rem;
        padding: 2.5rem;
        box-shadow:
            0 25px 50px -12px rgba(0, 0, 0, 0.5),
            inset 0 0 30px rgba(0, 0, 0, 0.2);
        text-align: center;
        width: 100%;
        max-width: 950px;
        border: 4px solid var(--accent-gold);
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    /* Main headings */
    h1, h2 {
        font-family: 'Bebas Neue', sans-serif;
        letter-spacing: 0.1em;
        text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
        -webkit-text-stroke: 1px var(--primary-dark);
    }
    
    /* Gradient for titles */
    h1 {
        font-size: 3.5rem;
        margin-bottom: 0.5rem;
        background: linear-gradient(90deg, #FFD700, #FFEF9F);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    h2 {
        font-size: 2.5rem;
        margin-top: 2rem;
        margin-bottom: 1.5rem;
        color: var(--light-text);
    }

    .team-odds-section {
        margin-top: 2rem;
        background-color: var(--section-bg);
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.4);
        border: 2px solid var(--highlight-blue);
        width: 100%;
    }

    .team-odds-list {
        list-style: none;
        padding: 0;
        margin-top: 1rem;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
    }

    .team-odds-list li {
        background-color: var(--container-bg);
        color: var(--light-text);
        padding: 1rem;
        border-radius: 0.75rem;
        font-size: 1rem;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-left: 5px solid var(--accent-gold);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .team-odds-list li:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4);
    }

    .team-odds-list li span:last-child {
        color: var(--accent-gold);
        font-weight: 900;
        font-size: 1.1rem;
    }

    /* Results section */
    .results-section {
        margin-top: 2.5rem;
        background-color: var(--section-bg);
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.4);
        border: 2px solid var(--highlight-blue);
        width: 100%;
    }

    .results-list {
        list-style: none;
        padding: 0;
        margin-top: 1.5rem;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .results-list li {
        background-color: var(--container-bg);
        color: var(--light-text);
        padding: 1rem;
        border-radius: 0.75rem;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-left: 5px solid var(--highlight-blue);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        transition: transform 0.2s ease;
    }

    .results-list li:hover {
        transform: scale(1.03);
    }

    .results-list li span:first-child {
        font-size: 1.2rem;
        margin-right: 0.5rem;
    }

    .results-list li span:last-child {
        font-size: 1.4rem;
        color: var(--accent-gold);
        font-family: 'Bebas Neue', sans-serif;
    }

    @keyframes ballAgitation {
0% { transform: translate(0, 0) rotate(0deg); }
20% { transform: translate(10px, -15px) rotate(10deg); } /* Move up slightly /
40% { transform: translate(-12px, 10px) rotate(-15deg); } / Move down slightly /
60% { transform: translate(8px, -10px) rotate(5deg); } / Move up again, less height /
80% { transform: translate(-5px, 5px) rotate(-5deg); } / Move down again, less height */
100% { transform: translate(0, 0) rotate(0deg); }
}

    /* The main lottery machine */
    .lottery-machine {
        position: relative;
        width: 80vw;
        max-width: 400px;
        aspect-ratio: 1;
        border-radius: 50%;
        margin: 3rem auto;
        overflow: hidden;
        border: 15px solid #a0b3c8;
        background: linear-gradient(180deg, #5b6d90, #2c3e59);
        box-shadow:
            0 0 50px rgba(255, 215, 0, 0.4),
            inset 0 0 80px rgba(255, 255, 255, 0.3),
            inset 0 0 120px rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
        padding: 20px;
        z-index: 0;
    }

    .lottery-machine::after {
        content: '';
        position: absolute;
        top: -30px;
        left: 50%;
        transform: translateX(-50%);
        width: 150px;
        height: 80px;
        background: #121f3d;
        border-radius: 50px 50px 0 0;
        border-bottom: 10px solid #a0b3c8;
        box-shadow: inset 0 -10px 25px rgba(0, 0, 0, 0.9);
        z-index: 5;
        pointer-events: none;
    }

    .ball {
        position: absolute;
        width: 50px;
        height: 50px;
        background: radial-gradient(circle at 30% 30%, #ffffff 0%, #f0f4f8 40%, #a0b3c8 80%, #778899 100%);
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: 900;
        color: var(--primary-dark);
        font-size: 1.1rem;
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.5), inset 0 0 10px rgba(255,255,255,0.8);
        cursor: default;
        transition: transform 0.8s ease-out, opacity 0.8s ease-out, top 0.8s ease-out, left 0.8s ease-out, background 0.3s, border-color 0.3s, box-shadow 0.3s;
        z-index: 2;
        /* --- ADDED ANIMATION PROPERTIES --- */
        animation-name: ballAgitation;
        animation-duration: 2s; /* Adjust speed as needed */
        animation-timing-function: ease-in-out;
        animation-iteration-count: infinite;
    }

    .ball.selected-for-shoot, .ball.drawn {
        animation: none !important; /* This is correct, it stops agitation when selected or drawn */
    }

    .ball.selected-for-shoot {
        background: radial-gradient(circle at top left, #fff 0%, var(--accent-gold) 100%);
        box-shadow: 0 0 25px var(--accent-gold), 0 5px 10px rgba(0,0,0,0.5);
        z-index: 10;
        transition: top 0.7s cubic-bezier(0.68, -0.55, 0.27, 1.55), left 0.7s cubic-bezier(0.68, -0.55, 0.27, 1.55), background 0.3s, box-shadow 0.3s;
    }

    .ball.drawn {
        transform: translateY(-400px) scale(0.1);
        opacity: 0;
        transition: transform 1.5s ease-in, opacity 1.5s ease-out;
        pointer-events: none;
        z-index: 1;
    }

    /* Display for the drawn ball */
    .drawn-ball-display {
        min-height: 120px;
        background-color: var(--section-bg);
        border-radius: 1.5rem;
        padding: 1.5rem;
        margin-top: 2rem;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.4);
        border: 4px dashed var(--accent-gold);
        position: relative;
        overflow: hidden;
    }
    
    .drawn-ball-display::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border-radius: 1.5rem;
        border: 4px solid var(--accent-gold);
        opacity: 0.5;
        animation: glowingBorder 1.5s infinite alternate ease-in-out;
        pointer-events: none;
    }

    @keyframes glowingBorder {
        from {
            box-shadow: 0 0 10px var(--accent-gold), 0 0 20px var(--accent-gold), 0 0 30px var(--accent-gold);
            opacity: 0.5;
        }
        to {
            box-shadow: 0 0 20px var(--accent-gold), 0 0 40px var(--accent-gold), 0 0 60px var(--accent-gold);
            opacity: 0.8;
        }
    }


@keyframes bounce {
    0%   { transform: translateY(0); }
    50%  { transform: translateY(10px); } /* Adjust this value for bounce height */
    100% { transform: translateY(0); }
}

@keyframes circle-motion {
    0% {
        transform: rotate(0deg) translateX(var(--circle-radius)) rotate(0deg);
    }
    100% {
        transform: rotate(360deg) translateX(var(--circle-radius)) rotate(-360deg);
    }
}
    .drawn-ball-display .current-pick-label {
        font-size: 1.75rem;
        font-weight: bold;
        color: var(--light-text);
        margin-bottom: 0.5rem;
        font-family: 'Bebas Neue', sans-serif;
        letter-spacing: 0.1em;
    }
    
    .drawn-ball-display .drawn-team-name {
        font-size: 3rem;
        font-weight: 900;
        text-transform: uppercase;
        font-family: 'Bebas Neue', sans-serif;
        text-shadow: 3px 3px 7px rgba(0, 0, 0, 0.7);
        letter-spacing: 0.15em;
        background: linear-gradient(90deg, #FFD700, #FFEF9F);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .btn {
        background: linear-gradient(90deg, #FFD700, #FFEF9F);
        color: var(--primary-dark);
        padding: 1rem 2rem;
        border-radius: 1rem;
        font-weight: 900;
        font-size: 1.5rem;
        border: none;
        cursor: pointer;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        margin-top: 2rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-family: 'Bebas Neue', sans-serif;
        text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
    }

    .btn:hover:not(:disabled) {
        transform: translateY(-5px) scale(1.05);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.6);
        background: linear-gradient(90deg, #FFEF9F, #FFD700); /* Inverted gradient on hover */
    }

    .btn:disabled {
        background: #6a748c;
        color: #b0b8c8;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
    }

    /* Message Box Styling */
    .message-box {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: var(--container-bg);
        color: var(--light-text);
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
        z-index: 1000;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-width: 350px;
        text-align: center;
        border: 3px solid var(--accent-gold);
    }

    .message-box button {
        margin-top: 20px;
        padding: 10px 20px;
        background-color: var(--highlight-blue);
        color: var(--light-text);
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        font-size: 1.1rem;
        transition: background-color 0.2s ease, transform 0.2s ease;
    }

    .message-box button:hover {
        background-color: #5a8bd4;
        transform: translateY(-2px);
    }


    @media (max-width: 768px) {
        h1 {
            font-size: 2.5rem;
        }
        h2 {
            font-size: 2rem;
        }
        .container {
            padding: 1.5rem;
        }
        .drawn-ball-display .drawn-team-name {
            font-size: 2.2rem;
        }
        .lottery-machine {
            width: 75vw;
            max-width: 300px;
            margin: 2rem auto;
        }
        .ball {
            width: 45px;
            height: 45px;
            font-size: 1rem;
        }
        .btn {
            font-size: 1.3rem;
            padding: 0.8rem 1.6rem;
        }
    }

  @media (max-width: 480px) {
    h1 {
        font-size: 2rem;
    }
    h2 {
        font-size: 1.5rem;
    }
    .container {
        padding: 1rem;
        border-radius: 1.5rem;
    }
    .drawn-ball-display .drawn-team-name {
        font-size: 1.8rem;
    }
    .team-odds-list,
    .results-list {
        grid-template-columns: 1fr;
        gap: 0.75rem;
    }
    .lottery-machine {
        width: 90vw;
        min-height: 250px;
    }
}

.picked {
    text-decoration: line-through;
    text-decoration-color: red;
    text-decoration-thickness: 6px;
    opacity: 0.5;
}

.audio-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.95);
    color: #FFD700;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999; /* Make sure it's on top of everything */
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2.5rem;
    text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.8);
    cursor: pointer;
    text-align: center;
    padding: 20px;
    box-sizing: border-box;
    transition: opacity 0.5s ease-in-out;
}

.audio-overlay.hidden {
    opacity: 0;
    pointer-events: none; /* Make it unclickable when hidden */
}

.overlay-content {
    animation: pulse 2s infinite ease-in-out;
}

@keyframes pulse {
    0% { transform: scale(1); opacity: 0.8; }
    50% { transform: scale(1.05); opacity: 1; }
    100% { transform: scale(1); opacity: 0.8; }
}

.hidden {
    display: none !important; /* Use !important to ensure it overrides other display properties */
}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
<div class="container">

    <h1 class="text-5xl mb-8 tracking-wider uppercase"
        style="
            font-family: 'Bebas Neue', sans-serif;
            color: #FFD700;
            text-shadow: 3px 3px 8px rgba(0, 0, 0, 0.9);
            letter-spacing: 3px;
        ">
        TCWR DY-NASTY<br/>
        Draft Lottery
    </h1>

    <div class="lottery-machine" id="lotteryMachine">
        <div class="text-xl font-semibold text-gray-400">Loading draft state...</div>
    </div>

    <div class="drawn-ball-display" id="drawnBallDisplay">
        <div class="current-pick-label" id="currentPickLabel">Ready to Draw for Pick #...</div>
        <div class="drawn-team-name" id="drawnTeamName"></div>
    </div>

    <button class="btn" id="runFullDraftBtn">Run Draft</button>
    
    <div class="results-section">
        <h2 class="text-4xl mb-6 tracking-wide uppercase"
            style="
                font-family: 'Bebas Neue', sans-serif;
                color: #FFD700;
                text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.8);
                letter-spacing: 2px;
            ">
            Draft Order Results
        </h2>
        <ul class="results-list" id="resultsList">
            </ul>
    </div>

    <div class="team-odds-section">
        <h2 class="text-4xl mb-6 tracking-wide uppercase" 
            style="
                font-family: 'Bebas Neue', sans-serif;
                color: #FFD700;
                text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.8);
                letter-spacing: 2px;
            ">
            Team Odds
        </h2>
        <ul id="teamOddsList" class="team-odds-list">
            </ul>
    </div>

    <div class="commissioner-tools">
        <h2 class="text-2xl font-bold mb-4 text-orange-300">Commissioner Tools</h2>
        
        <div id="commissionerLogin">
            <input type="password" id="commissionerPassword" placeholder="Enter Password" class="p-3 rounded-md bg-gray-900 border border-gray-700 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 flex-grow max-w-xs">
            <button id="unlockCommissionerBtn" class="btn mt-4 bg-blue-600 hover:bg-blue-700 text-white">Unlock</button>
        </div>

        <div id="commissionerPanel" class="hidden">
            <p class="text-sm text-gray-400 mb-4">Update team names and their weighted odds below. The 'weight' determines the number of balls for each team. Total weight should ideally sum to 100.</p>
            <div id="memberConfigInputs">
            </div>
            <button id="saveConfigBtn" class="btn mt-4 bg-green-600 hover:bg-green-700 text-white">Save Configuration</button>
            <button id="resetDraftBtn" class="btn mt-4 ml-2 bg-red-600 hover:bg-red-700 text-white">Reset Draft</button>
        </div>
    </div>
        <div id="messageBox" class="message-box">
        <p id="messageText"></p>
        <button onclick="document.getElementById('messageBox').style.display = 'none'">OK</button>
    </div>

</div> <div id="audioOverlay" class="audio-overlay">
    <div class="overlay-content">
        <div class="explanation-text" style="max-width: 800px; padding: 2rem; border-radius: 1rem; text-shadow: 1px 1px 4px rgba(0,0,0,0.7); text-align: center;">
            <h3 style="font-family: 'Bebas Neue', sans-serif; font-size: 2.5rem; letter-spacing: 0.1em; margin-bottom: 1rem; color: #FFD700; text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.8);">
                How the Lottery Works: Reverse Order Reveal
            </h3>
            <p style="font-size: 1.1rem; line-height: 1.5; margin-bottom: 1.5rem;">
                Our lottery builds suspense by revealing the draft order in reverse, from Pick #8 down to the highly anticipated Pick #1.
                <br/><br/>
                Here’s the key rule: Once a team is drawn from the machine, they are awarded the current pick and are **eliminated from all future draws**.
            </p>
            
            <div style="text-align: left; margin: 0 auto; line-height: 1.6; max-width: 500px;">
                <p style="font-size: 1.1rem; margin-bottom: 0.5rem; font-weight: bold;">This means:</p>
                <ul style="list-style: disc; list-style-position: inside; padding-left: 1rem; font-size: 1rem;">
                    <li>
                        <strong style="color: #FFD700;">Teams with the highest odds</strong> have the highest chance of being drawn for the very first pick revealed... **Pick #8**.
                    </li>
                    <li>
                        <strong style="color: #FFD700;">Teams with the lowest odds</strong> are long shots, but if they get lucky and avoid being picked early, their odds of winning a top pick like #1 increase with every round.
                    </li>
                </ul>
            </div>
            <p style="font-size: 1rem; margin-top: 1.5rem; font-style: italic;">
                The suspense builds as the most likely teams are eliminated, leaving a shot at the jackpot for the long shots.
            </p>
        </div>
        
        <p style="margin-top: 2.5rem; font-size: 1.8rem; font-weight: bold; text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.8);" class="animate-pulse">
            Click anywhere to start the simulator!
        </p>
    </div>
</div>

 
<script type="module">
// --- Supabase ---
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

const COMMISSIONER_PASSWORD = 'Asher'; 
const SUPABASE_URL = 'https://jheqfwykhvyngfqawknr.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpoZXFmd3lraHZ5bmdmcWF3a25yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ5NDE3MjEsImV4cCI6MjA2MDUxNzcyMX0.LLWSmRdZW_5XD2Z8NqGB5BTP3hAtk63pOnZiSckf7BM';
const SUPABASE_TABLE_NAME = 'draft_configs';
const SUPABASE_ORDERS_TABLE_NAME = 'draft_orders';
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let members = []; 
let availableMembers = [];
let draftOrder = [];
let drawing = false;
let pickCounter = 0;
let isDraftSaved = false;

let espnAudio = null;
let crowdShoutAudio = null;
let disappointmentAudio = null;
let cheeringAudio = null;
let crowdCheersAudio = null;
let audioTimeout;

const lotteryMachine = document.getElementById('lotteryMachine');
const runFullDraftBtn = document.getElementById('runFullDraftBtn');
const currentPickLabel = document.getElementById('currentPickLabel');
const drawnTeamNameDisplay = document.getElementById('drawnTeamName');
const resultsList = document.getElementById('resultsList');
const teamOddsList = document.getElementById('teamOddsList');
const audioOverlay = document.getElementById('audioOverlay');
const commissionerLogin = document.getElementById('commissionerLogin');
const commissionerPasswordInput = document.getElementById('commissionerPassword');
const unlockCommissionerBtn = document.getElementById('unlockCommissionerBtn');
const commissionerPanel = document.getElementById('commissionerPanel');
const memberConfigInputs = document.getElementById('memberConfigInputs');
const saveConfigBtn = document.getElementById('saveConfigBtn');
const resetDraftBtn = document.getElementById('resetDraftBtn');

// --- 1. COMMISSIONER LOGIC ---
function handleCommissionerUnlock(e) {
    if (e) e.preventDefault();
    if (commissionerPasswordInput.value === COMMISSIONER_PASSWORD) {
        commissionerPanel.classList.remove('hidden');
        commissionerLogin.classList.add('hidden');
        showMessage("Commissioner tools unlocked!");
    } else {
        showMessage("Incorrect password. Please try again.");
    }
    commissionerPasswordInput.value = ''; 
}

// --- 2. AUDIO PLAYBACK ---
function playPickAudio(pickNumber) {
    clearTimeout(audioTimeout);
    [crowdShoutAudio, disappointmentAudio, cheeringAudio, crowdCheersAudio].forEach(audio => {
        if (audio) {
            audio.pause();
            audio.currentTime = 0;
        }
    });

    if (espnAudio) espnAudio.volume = 0.1;

    let audioToPlay;
    if (pickNumber <= 4) audioToPlay = cheeringAudio;
    else if (pickNumber <= 7) audioToPlay = disappointmentAudio;
    else if (pickNumber === 8) audioToPlay = crowdShoutAudio;

    if (audioToPlay) {
        audioToPlay.play().catch(e => console.error("Audio playback error:", e));
        audioTimeout = setTimeout(() => {
            audioToPlay.pause();
            audioToPlay.currentTime = 0;
            if (espnAudio) espnAudio.volume = 0.5;
        }, 3000);
    }
}

// --- 3. SUPABASE DATA LOGIC ---
async function fetchMembersFromSupabase() {
    const { data, error } = await supabase
        .from(SUPABASE_TABLE_NAME)
        .select('id, members_data')
        .order('members_data->>weight', { ascending: false });

    if (error) return [];
    return data.map(item => ({
        id: item.id,
        name: item.members_data.name,
        weight: item.members_data.weight,
        originalWeightDisplay: item.members_data.originalWeightDisplay,
        color: item.members_data.color 
    }));
}

async function loadDraftOrderFromSupabase() {
    const { data, error } = await supabase
        .from(SUPABASE_ORDERS_TABLE_NAME)
        .select('order_data')
        .order('order_data->>pick', { ascending: false });
    
    if (error || !data) return null;
    return data.map(item => item.order_data);
}

async function saveMembersToSupabase(newMembers) {
    const formattedData = newMembers.map(member => ({
        id: member.id,
        members_data: {
            name: member.name,
            weight: member.weight,
            originalWeightDisplay: member.originalWeightDisplay
        }
    }));
    const { error } = await supabase.from(SUPABASE_TABLE_NAME).upsert(formattedData, { onConflict: 'id' });
    return !error;
}

async function saveDraftOrderToSupabase(draftOrder) {
    const formattedData = draftOrder.map(pick => ({
        id: `pick_${pick.pick}`,
        order_data: {
            pick: pick.pick,
            member: pick.member,
            originalWeightDisplay: pick.originalWeightDisplay
        }
    }));
    const { error } = await supabase.from(SUPABASE_ORDERS_TABLE_NAME).upsert(formattedData, { onConflict: 'id' });
    return !error;
}

async function clearDraftOrderFromSupabase() {
    const { error } = await supabase.from(SUPABASE_ORDERS_TABLE_NAME).delete().not('id', 'is', null);
    if (!error) sessionStorage.removeItem('hasSeenDraftAnimation');
    return !error;
}

// --- 4. DRAFT LOGIC ---
async function initializeDraftState() {
    members = await fetchMembersFromSupabase();
    if (members.length === 0) {
        lotteryMachine.innerHTML = '<div class="text-xl font-semibold text-gray-400">No teams configured!</div>';
        if (runFullDraftBtn) runFullDraftBtn.disabled = true;
        return;
    }

    const savedDraftOrder = await loadDraftOrderFromSupabase();
    const hasSeenAnimation = sessionStorage.getItem('hasSeenDraftAnimation');

    if (savedDraftOrder && savedDraftOrder.length > 0) {
        isDraftSaved = true;
        draftOrder = savedDraftOrder.sort((a, b) => a.pick - b.pick);
        if (hasSeenAnimation) {
            showResults();
            if (runFullDraftBtn) runFullDraftBtn.textContent = 'Replay Draft Animation';
        } else {
            pickCounter = members.length;
            availableMembers = members.map(member => ({ ...member }));
            setupNewRun();
        }
    } else {
        isDraftSaved = false;
        pickCounter = members.length;
        availableMembers = members.map(member => ({ ...member }));
        setupNewRun();
    }
    initializeMemberConfigInputs();
}

function setupNewRun() {
    if (runFullDraftBtn) runFullDraftBtn.textContent = 'Run Draft';
    if (currentPickLabel) currentPickLabel.textContent = `Ready for Pick #${pickCounter}...`;
    initializeResultsList();
    populateBalls();
    displayTeamOdds();
}

function showResults() {
    if (resultsList) resultsList.style.display = 'block';
    updateUIFromCurrentState();
    lotteryMachine.innerHTML = '';
}

function populateBalls() {
    if (!lotteryMachine || availableMembers.length === 0) return;
    lotteryMachine.innerHTML = '';

    const ballsToRender = [];
    availableMembers.forEach(member => {
        for (let i = 0; i < (member.weight || 0); i++) {
            ballsToRender.push({ teamId: member.id });
        }
    });

    ballsToRender.sort(() => Math.random() - 0.5).forEach(ballData => {
        const ball = document.createElement('div');
        ball.classList.add('ball', 'absolute', 'rounded-full', 'flex', 'items-center', 'justify-center');
        ball.dataset.teamId = ballData.teamId;
        const member = members.find(m => m.id === ballData.teamId);
        if (member) ball.style.backgroundColor = member.color;
        
        lotteryMachine.appendChild(ball);
        
        const radius = Math.random() * 50 + 50;
        ball.style.setProperty('--circle-radius', `${radius}px`);
        ball.style.animation = `circle-motion ${Math.random() * 4 + 4}s linear infinite`;
    });
}

async function performSingleDraw() {
    currentPickLabel.textContent = `Drawing for Pick #${pickCounter}...`;
    lotteryMachine.querySelectorAll('.ball').forEach(b => b.style.animationPlayState = 'paused');
    await new Promise(r => setTimeout(r, 2000));

    const drawnMember = drawWeightedMember();
    if (drawnMember) {
        playPickAudio(pickCounter);
        drawnTeamNameDisplay.textContent = drawnMember.name;
        
        if (!isDraftSaved) {
            draftOrder.push({ pick: pickCounter, member: drawnMember.name, originalWeightDisplay: drawnMember.originalWeightDisplay });
        }

        const pickElement = resultsList.querySelector(`li[data-pick-num="${pickCounter}"]`);
        if (pickElement) {
            pickElement.innerHTML = `<span>Pick ${pickCounter}:</span> <span>${drawnMember.name}</span>`;
            pickElement.className = 'bg-green-500 text-white p-2 rounded';
        }
    }
    lotteryMachine.querySelectorAll('.ball').forEach(b => b.style.animationPlayState = 'running');
}

function drawWeightedMember() {
    if (isDraftSaved) return members.find(m => m.name === draftOrder.find(p => p.pick === pickCounter)?.member);
    const totalWeight = availableMembers.reduce((s, m) => s + m.weight, 0);
    let r = Math.random() * totalWeight;
    for (let i = 0; i < availableMembers.length; i++) {
        r -= availableMembers[i].weight;
        if (r <= 0) return availableMembers.splice(i, 1)[0];
    }
}

async function runFullDraftSimulation() {
    if (drawing) return;
    drawing = true;
    runFullDraftBtn.disabled = true;

    if (isDraftSaved) {
        pickCounter = members.length;
        availableMembers = members.map(m => ({ ...m }));
        populateBalls();
    }

    while (pickCounter >= 1) {
        await performSingleDraw();
        pickCounter--;
    }

    if (!isDraftSaved) await saveDraftOrderToSupabase(draftOrder);
    isDraftSaved = true;
    sessionStorage.setItem('hasSeenDraftAnimation', 'true');
    showResults();
    drawing = false;
    runFullDraftBtn.disabled = false;
    runFullDraftBtn.textContent = 'Replay Draft Animation';
}

// --- 5. INITIALIZATION & UI HELPERS ---
function initializeResultsList() {
    if (!resultsList) return;
    resultsList.innerHTML = '';
    for (let i = members.length; i >= 1; i--) {
        const li = document.createElement('li');
        li.innerHTML = `<span>Pick ${i}:</span> <span class="text-gray-400">Pending...</span>`;
        li.setAttribute('data-pick-num', i);
        li.className = 'bg-gray-700 text-gray-300 p-2 mb-1 rounded';
        resultsList.appendChild(li);
    }
}

function initializeMemberConfigInputs() {
    if (!memberConfigInputs) return;
    memberConfigInputs.innerHTML = members.map(m => `
        <div class="flex gap-2 mb-2">
            <input type="text" id="${m.id}-name" value="${m.name}" class="p-1 border rounded">
            <input type="number" id="${m.id}-weight" value="${m.weight}" class="w-16 p-1 border rounded">
        </div>
    `).join('');
}

function showMessage(msg) {
    const box = document.getElementById('messageBox');
    if (box) {
        document.getElementById('messageText').innerText = msg;
        box.style.display = 'flex';
    }
}

function handleFirstInteraction() {
    if (!espnAudio) {
        espnAudio = new Audio('Espnprimetime.m4a');
        espnAudio.loop = true;
        espnAudio.volume = 0.5;
        crowdShoutAudio = new Audio('crowd-shouting-6325.mp3');
        disappointmentAudio = new Audio('disappointment.mp3');
        cheeringAudio = new Audio('cheering.mp3');
        crowdCheersAudio = new Audio('crowd-cheers-312833.mp3');
    }
    espnAudio.play().catch(() => {});
    if (audioOverlay) audioOverlay.style.display = 'none';
}

// --- 6. EVENT LISTENERS ---
document.addEventListener('DOMContentLoaded', () => {
    initializeDraftState();

    if (runFullDraftBtn) runFullDraftBtn.addEventListener('click', runFullDraftSimulation);
    if (unlockCommissionerBtn) unlockCommissionerBtn.addEventListener('click', handleCommissionerUnlock);
    if (commissionerLogin) commissionerLogin.addEventListener('submit', handleCommissionerUnlock);
    
    if (saveConfigBtn) {
        saveConfigBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            // Logic to collect values from inputs and call saveMembersToSupabase
            showMessage("Config saved!");
        });
    }

    if (resetDraftBtn) {
        resetDraftBtn.addEventListener('click', async () => {
            if (await clearDraftOrderFromSupabase()) initializeDraftState();
        });
    }

    if (audioOverlay) audioOverlay.addEventListener('click', handleFirstInteraction, { once: true });
    document.addEventListener('keydown', handleFirstInteraction, { once: true });
});
</script>
 
</body>
</html>
